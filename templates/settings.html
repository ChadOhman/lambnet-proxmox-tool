{% extends "base.html" %}
{% block title %}Settings - Mastodon Canada Administration Tool{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-gear"></i> Settings</h2>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card bg-dark">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-envelope"></i> Gmail Notifications</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/settings/email">
                    <div class="mb-3">
                        <label class="form-label">Gmail Address</label>
                        <input type="email" class="form-control" name="gmail_address" value="{{ settings.gmail_address or '' }}" placeholder="yourname@gmail.com">
                        <div class="form-text">The Gmail account to send notifications from.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gmail App Password</label>
                        <input type="password" class="form-control" name="gmail_app_password" placeholder="{{ '********' if settings.gmail_app_password else 'Generate at myaccount.google.com' }}">
                        <div class="form-text">
                            Create an App Password in your Google Account settings under Security > 2-Step Verification > App passwords.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notification Recipients</label>
                        <input type="text" class="form-control" name="email_recipients" value="{{ settings.email_recipients or '' }}" placeholder="admin@example.com, ops@example.com">
                        <div class="form-text">Comma-separated list of email addresses.</div>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="email_enabled" id="emailEnabled" {{ 'checked' if settings.email_enabled == 'true' }}>
                        <label class="form-check-label" for="emailEnabled">Enable email notifications</label>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save Email Settings</button>
                        <button type="submit" formaction="/settings/email/test" class="btn btn-outline-secondary">
                            <i class="bi bi-send"></i> Send Test Email
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Cloudflare Zero Trust -->
        <div class="card bg-dark mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-shield-check"></i> Cloudflare Zero Trust
                    {% if settings.cf_access_enabled == 'true' %}
                    <span class="badge bg-success ms-2">Active</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" action="/settings/cloudflare">
                    <div class="alert alert-info py-2 mb-3">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            Integrate with Cloudflare Access to add SSO authentication and secure external access.
                            Requires a Cloudflare Zero Trust account and a tunnel or DNS-proxied domain.
                        </small>
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="cf_access_enabled" id="cfEnabled" {{ 'checked' if settings.cf_access_enabled == 'true' }}>
                        <label class="form-check-label" for="cfEnabled"><strong>Enable Cloudflare Access Authentication</strong></label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Team Domain</label>
                        <input type="text" class="form-control" name="cf_access_team_domain" value="{{ settings.cf_access_team_domain or '' }}" placeholder="myteam.cloudflareaccess.com">
                        <div class="form-text">
                            Your Cloudflare Zero Trust team domain. Found in the Zero Trust dashboard under Settings > Custom Pages.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Application Audience (AUD) Tag</label>
                        <input type="text" class="form-control font-monospace" name="cf_access_audience" value="{{ settings.cf_access_audience or '' }}" placeholder="e.g. 32eafc7c8cdccc41f3a275e99a7a1e8f...">
                        <div class="form-text">
                            The Application Audience (AUD) tag from your Cloudflare Access application.
                            Found in Zero Trust > Access > Applications > your app > Overview.
                        </div>
                    </div>

                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" name="cf_access_auto_provision" id="cfAutoProvision" {{ 'checked' if settings.cf_access_auto_provision != 'false' }}>
                        <label class="form-check-label" for="cfAutoProvision">Auto-provision users from CF Access</label>
                        <div class="form-text">Automatically create user accounts when new users authenticate through Cloudflare Access. New users will have no permissions until an admin assigns tags.</div>
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="cf_access_bypass_local_auth" id="cfBypass" {{ 'checked' if settings.cf_access_bypass_local_auth == 'true' }}>
                        <label class="form-check-label" for="cfBypass">Use CF Access as sole authentication</label>
                        <div class="form-text text-warning">
                            <i class="bi bi-exclamation-triangle"></i>
                            When enabled, local login is disabled and only CF Access authenticated users can access the app.
                            Make sure CF Access is working before enabling this!
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Cloudflare Settings</button>
                </form>

                {% if settings.cf_access_enabled == 'true' %}
                <hr class="border-secondary">
                <h6>Setup Guide</h6>

                <ul class="nav nav-tabs nav-tabs-sm mb-3" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active small" data-bs-toggle="tab" data-bs-target="#cfExistingTunnel" type="button">Use Existing Tunnel</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link small" data-bs-toggle="tab" data-bs-target="#cfNewTunnel" type="button">Create New Tunnel</button>
                    </li>
                </ul>

                <div class="tab-content">
                    <div class="tab-pane fade show active" id="cfExistingTunnel">
                        <p class="small text-muted mb-2">If you already have <code>cloudflared</code> running elsewhere (another CT, VM, or the Proxmox host), add a route to your existing tunnel:</p>
                        <ol class="small mb-0">
                            <li>Open the <strong>Cloudflare Zero Trust dashboard</strong> > Networks > Tunnels</li>
                            <li>Select your existing tunnel and click <strong>Configure</strong></li>
                            <li>Under <strong>Public Hostname</strong>, add a new entry:
                                <ul>
                                    <li>Subdomain: e.g. <code>lambnet</code></li>
                                    <li>Domain: your domain</li>
                                    <li>Service: <code>http://{{ request.host.split(':')[0] if request.host else 'CT-IP' }}:5000</code></li>
                                </ul>
                            </li>
                            <li>Go to <strong>Access > Applications</strong> and create an application for the hostname</li>
                            <li>Copy the <strong>Application Audience (AUD)</strong> tag and paste it above</li>
                            <li>Configure Access Policies (e.g. allow specific email domains)</li>
                        </ol>
                    </div>
                    <div class="tab-pane fade" id="cfNewTunnel">
                        <p class="small text-muted mb-2">Install <code>cloudflared</code> directly on this CT and create a dedicated tunnel:</p>
                        <ol class="small mb-0">
                            <li>Install cloudflared: <code>bash setup.sh --cloudflared</code></li>
                            <li>Authenticate: <code>cloudflared tunnel login</code></li>
                            <li>Create tunnel: <code>cloudflared tunnel create lambnet</code></li>
                            <li>Configure the tunnel to route to <code>http://localhost:5000</code></li>
                            <li>In Zero Trust dashboard, create an Access Application for your tunnel's hostname</li>
                            <li>Copy the Application Audience (AUD) tag and paste it above</li>
                            <li>Configure Access Policies (e.g. allow specific email domains)</li>
                        </ol>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <!-- Local Network Bypass -->
        <div class="card bg-dark">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-house-door"></i> Local Network Access
                    {% if settings.local_bypass_enabled != 'false' %}
                    <span class="badge bg-success ms-2">Active</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" action="/settings/local-bypass">
                    <div class="alert alert-info py-2 mb-3">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            Requests from trusted subnets are automatically authenticated as admin
                            with no login required. This bypasses both local auth and Cloudflare Access.
                        </small>
                    </div>

                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="local_bypass_enabled" id="localBypass" {{ 'checked' if settings.local_bypass_enabled != 'false' }}>
                        <label class="form-check-label" for="localBypass"><strong>Enable local network bypass</strong></label>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Trusted Subnets</label>
                        <input type="text" class="form-control font-monospace" name="trusted_subnets" value="{{ settings.trusted_subnets or '10.0.0.0/8' }}" placeholder="10.0.0.0/8">
                        <div class="form-text">
                            Comma-separated CIDR notation. Common examples:<br>
                            <code>10.0.0.0/8</code> (Class A private),
                            <code>192.168.0.0/16</code> (Class C private),
                            <code>172.16.0.0/12</code> (Class B private)
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Save Local Access Settings</button>
                </form>
            </div>
        </div>

        <div class="card bg-dark mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock"></i> Scan Settings</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/settings/scan">
                    <div class="mb-3">
                        <label class="form-label">Scan Interval (hours)</label>
                        <input type="number" class="form-control" name="scan_interval" value="{{ settings.scan_interval or '6' }}" min="1" max="168">
                        <div class="form-text">How often to automatically scan for updates (1-168 hours).</div>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="scan_enabled" id="scanEnabled" {{ 'checked' if settings.scan_enabled != 'false' }}>
                        <label class="form-check-label" for="scanEnabled">Enable automatic scanning</label>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Scan Settings</button>
                </form>
            </div>
        </div>

        <div class="card bg-dark mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Application</h5>
            </div>
            <div class="card-body">
                <table class="table table-dark table-sm mb-3">
                    <tr><td class="text-muted">Version</td><td>v{{ config.get('APP_VERSION', 'unknown') }}</td></tr>
                    <tr><td class="text-muted">GitHub</td><td><a href="https://github.com/{{ config.get('GITHUB_REPO', '') }}" target="_blank">{{ config.get('GITHUB_REPO', '') }}</a></td></tr>
                </table>
                <form method="post" action="/settings/app-update-mode">
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="app_auto_update" id="appAutoUpdate" {{ 'checked' if settings.app_auto_update == 'true' }}>
                        <label class="form-check-label" for="appAutoUpdate"><strong>Enable automatic updates</strong></label>
                        <div class="form-text">When enabled, the app will check for new releases every 6 hours and automatically update and restart.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Update Branch</label>
                        <input type="text" class="form-control form-control-sm font-monospace" name="app_update_branch" value="{{ settings.app_update_branch or '' }}" placeholder="Leave blank for release-based updates">
                        <div class="form-text">Set a branch name (e.g. <code>main</code>, <code>dev</code>) to pull updates from that branch instead of GitHub releases. Leave blank to use tagged releases.</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm">Save</button>
                        <button type="submit" formaction="/settings/check-update" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-arrow-repeat"></i> Check for Updates
                        </button>
                    </div>
                </form>
                {% if update_available %}
                <div class="alert alert-info mt-3 mb-0">
                    <strong>Update available:</strong> {{ update_version }}
                    <form method="post" action="/settings/apply-update" class="mt-2">
                        <button type="submit" class="btn btn-sm btn-info" onclick="return confirm('This will update the application and restart the service. Continue?')">
                            <i class="bi bi-download"></i> Update Now
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- UniFi Controller -->
        <div class="card bg-dark mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-router"></i> UniFi Controller
                    {% if settings.unifi_enabled == 'true' %}
                    <span class="badge bg-success ms-2">Active</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" action="/settings/unifi">
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="unifi_enabled" id="unifiEnabled" {{ 'checked' if settings.unifi_enabled == 'true' }}>
                        <label class="form-check-label" for="unifiEnabled"><strong>Enable UniFi Integration</strong></label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Controller URL</label>
                        <input type="text" class="form-control" name="unifi_base_url" value="{{ settings.unifi_base_url or '' }}" placeholder="https://10.0.4.1">
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="unifi_username" value="{{ settings.unifi_username or '' }}" placeholder="admin">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="unifi_password" placeholder="{{ '********' if settings.unifi_password else '' }}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Site</label>
                            <input type="text" class="form-control" name="unifi_site" value="{{ settings.unifi_site or 'default' }}" placeholder="default">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Subnet Filter</label>
                            <input type="text" class="form-control font-monospace" name="unifi_filter_subnet" value="{{ settings.unifi_filter_subnet or '' }}" placeholder="10.0.4.0/24 (blank=all)">
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="unifi_is_udm" id="unifiIsUdm" {{ 'checked' if settings.unifi_is_udm != 'false' }}>
                        <label class="form-check-label" for="unifiIsUdm">UDM / UniFi OS (uses <code>/proxy/network</code> prefix)</label>
                        <div class="form-text">Uncheck for standalone UniFi Controller software.</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save UniFi Settings</button>
                        <button type="submit" formaction="/settings/unifi/test" class="btn btn-outline-secondary">
                            <i class="bi bi-plug"></i> Test Connection
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Security Info -->
        <div class="card bg-dark mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-shield-lock"></i> Security</h5>
            </div>
            <div class="card-body">
                <table class="table table-dark table-sm mb-0">
                    <tr>
                        <td class="text-muted">Authentication</td>
                        <td>
                            {% if settings.cf_access_enabled == 'true' and settings.cf_access_bypass_local_auth == 'true' %}
                            <span class="badge bg-success">CF Access Only</span>
                            {% elif settings.cf_access_enabled == 'true' %}
                            <span class="badge bg-info">CF Access + Local</span>
                            {% else %}
                            <span class="badge bg-secondary">Local Only</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">HSTS</td>
                        <td><span class="badge bg-success">Enabled</span></td>
                    </tr>
                    <tr>
                        <td class="text-muted">XSS Protection</td>
                        <td><span class="badge bg-success">Enabled</span></td>
                    </tr>
                    <tr>
                        <td class="text-muted">Credentials</td>
                        <td><span class="badge bg-success">Encrypted (Fernet)</span></td>
                    </tr>
                    <tr>
                        <td class="text-muted">LAN Bypass</td>
                        <td>
                            {% if settings.local_bypass_enabled != 'false' %}
                            <span class="badge bg-info">{{ settings.trusted_subnets or '10.0.0.0/8' }}</span>
                            {% else %}
                            <span class="badge bg-secondary">Disabled</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}
