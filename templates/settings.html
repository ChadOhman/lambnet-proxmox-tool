{% extends "base.html" %}
{% block title %}Settings - Mastodon Canada Administration Tool{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-gear"></i> Settings</h2>

<div class="row g-4">
    <div class="col-lg-6">
        <div class="card bg-dark">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-envelope"></i> Gmail Notifications</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/settings/email">
                    <div class="mb-3">
                        <label class="form-label">Gmail Address</label>
                        <input type="email" class="form-control" name="gmail_address" value="{{ settings.gmail_address or '' }}" placeholder="yourname@gmail.com">
                        <div class="form-text">The Gmail account to send notifications from.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Gmail App Password</label>
                        <input type="password" class="form-control" name="gmail_app_password" placeholder="{{ '********' if settings.gmail_app_password else 'Generate at myaccount.google.com' }}">
                        <div class="form-text">
                            Create an App Password in your Google Account settings under Security > 2-Step Verification > App passwords.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notification Recipients</label>
                        <input type="text" class="form-control" name="email_recipients" value="{{ settings.email_recipients or '' }}" placeholder="admin@example.com, ops@example.com">
                        <div class="form-text">Comma-separated list of email addresses.</div>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="email_enabled" id="emailEnabled" {{ 'checked' if settings.email_enabled == 'true' }}>
                        <label class="form-check-label" for="emailEnabled">Enable email notifications</label>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save Email Settings</button>
                        <button type="submit" formaction="/settings/email/test" class="btn btn-outline-secondary">
                            <i class="bi bi-send"></i> Send Test Email
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- UniFi Controller -->
        <div class="card bg-dark mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-router"></i> UniFi Controller
                    {% if settings.unifi_enabled == 'true' %}
                    <span class="badge bg-success ms-2">Active</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" action="/settings/unifi">
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="unifi_enabled" id="unifiEnabled" {{ 'checked' if settings.unifi_enabled == 'true' }}>
                        <label class="form-check-label" for="unifiEnabled"><strong>Enable UniFi Integration</strong></label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Controller URL</label>
                        <input type="text" class="form-control" name="unifi_base_url" value="{{ settings.unifi_base_url or '' }}" placeholder="https://10.0.4.1">
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" name="unifi_username" value="{{ settings.unifi_username or '' }}" placeholder="admin">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" name="unifi_password" placeholder="{{ '********' if settings.unifi_password else '' }}">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Site</label>
                            <input type="text" class="form-control" name="unifi_site" value="{{ settings.unifi_site or 'default' }}" placeholder="default">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Subnet Filter</label>
                            <input type="text" class="form-control font-monospace" name="unifi_filter_subnet" value="{{ settings.unifi_filter_subnet or '' }}" placeholder="10.0.4.0/24 (blank=all)">
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="unifi_is_udm" id="unifiIsUdm" {{ 'checked' if settings.unifi_is_udm != 'false' }}>
                        <label class="form-check-label" for="unifiIsUdm">UDM / UniFi OS (uses <code>/proxy/network</code> prefix)</label>
                        <div class="form-text">Uncheck for standalone UniFi Controller software.</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">Save UniFi Settings</button>
                        <button type="submit" formaction="/settings/unifi/test" class="btn btn-outline-secondary">
                            <i class="bi bi-plug"></i> Test Connection
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card bg-dark">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock"></i> Scan & Discovery Settings</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/settings/scan">
                    <h6 class="text-muted mb-2">Guest Discovery</h6>
                    <div class="mb-3">
                        <label class="form-label">Discovery Interval (hours)</label>
                        <input type="number" class="form-control" name="discovery_interval" value="{{ settings.discovery_interval or '4' }}" min="1" max="168">
                        <div class="form-text">How often to refresh guest lists from Proxmox hosts (1-168 hours).</div>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="discovery_enabled" id="discoveryEnabled" {{ 'checked' if settings.discovery_enabled != 'false' }}>
                        <label class="form-check-label" for="discoveryEnabled">Enable automatic discovery</label>
                    </div>
                    <hr class="border-secondary">
                    <h6 class="text-muted mb-2">Update Scanning</h6>
                    <div class="mb-3">
                        <label class="form-label">Scan Interval (hours)</label>
                        <input type="number" class="form-control" name="scan_interval" value="{{ settings.scan_interval or '6' }}" min="1" max="168">
                        <div class="form-text">How often to automatically scan guests for updates (1-168 hours).</div>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="scan_enabled" id="scanEnabled" {{ 'checked' if settings.scan_enabled != 'false' }}>
                        <label class="form-check-label" for="scanEnabled">Enable automatic scanning</label>
                    </div>
                    <hr class="border-secondary">
                    <h6 class="text-muted mb-2">Service Health Checks</h6>
                    <div class="mb-3">
                        <label class="form-label">Check Interval (minutes)</label>
                        <input type="number" class="form-control" name="service_check_interval" value="{{ settings.service_check_interval or '5' }}" min="1" max="60">
                        <div class="form-text">How often to check service status on guests (1-60 minutes).</div>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="service_check_enabled" id="serviceCheckEnabled" {{ 'checked' if settings.service_check_enabled != 'false' }}>
                        <label class="form-check-label" for="serviceCheckEnabled">Enable automatic service health checks</label>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Settings</button>
                </form>
            </div>
        </div>

        <div class="card bg-dark mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-hdd"></i> Backup Defaults</h5>
            </div>
            <div class="card-body">
                <form method="post" action="/settings/backups">
                    <div class="mb-3">
                        <label class="form-label">Default Backup Storage</label>
                        <input type="text" class="form-control" name="backup_storage" value="{{ settings.backup_storage or '' }}" placeholder="e.g. local, nfs-backup, pbs">
                        <div class="form-text">
                            Proxmox storage ID for vzdump backups. Must support backup content type.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Backup Mode</label>
                        <select class="form-select" name="backup_mode">
                            <option value="snapshot" {{ 'selected' if settings.backup_mode == 'snapshot' }}>Snapshot (no downtime)</option>
                            <option value="suspend" {{ 'selected' if settings.backup_mode == 'suspend' }}>Suspend (brief pause)</option>
                            <option value="stop" {{ 'selected' if settings.backup_mode == 'stop' }}>Stop (guest stopped during backup)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Compression</label>
                        <select class="form-select" name="backup_compress">
                            <option value="zstd" {{ 'selected' if settings.backup_compress == 'zstd' }}>ZSTD (recommended)</option>
                            <option value="lzo" {{ 'selected' if settings.backup_compress == 'lzo' }}>LZO (fast)</option>
                            <option value="gzip" {{ 'selected' if settings.backup_compress == 'gzip' }}>GZIP (compatible)</option>
                            <option value="0" {{ 'selected' if settings.backup_compress == '0' }}>None</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Backup Settings</button>
                </form>
            </div>
        </div>

        <div class="card bg-dark mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Application</h5>
            </div>
            <div class="card-body">
                <table class="table table-dark table-sm mb-3">
                    <tr>
                        <td class="text-muted">Running</td>
                        <td>
                            {%- if config.get('APP_VERSION_STALE') and config.get('GIT_COMMIT') -%}
                                <span class="badge bg-warning text-dark">{{ config.get('GIT_BRANCH', 'main') }}</span>
                                <code class="ms-1">{{ config.get('GIT_COMMIT') }}</code>
                                <span class="text-muted ms-1">(ahead of v{{ config.get('APP_VERSION') }})</span>
                            {%- elif not config.get('GIT_COMMIT') or config.get('APP_VERSION') == 'unknown' -%}
                                v{{ config.get('APP_VERSION', 'unknown') }}
                            {%- else -%}
                                v{{ config.get('APP_VERSION', 'unknown') }}
                                <code class="ms-1">{{ config.get('GIT_COMMIT') }}</code>
                            {%- endif -%}
                        </td>
                    </tr>
                    {% if latest_release %}
                    <tr>
                        <td class="text-muted">Latest Release</td>
                        <td>
                            <a href="https://github.com/{{ config.get('GITHUB_REPO', '') }}/releases/tag/v{{ latest_release }}" target="_blank">v{{ latest_release }}</a>
                            {% if not config.get('APP_VERSION_STALE') and config.get('APP_VERSION') == latest_release %}
                                <span class="badge bg-success ms-1">Up to date</span>
                            {% elif config.get('APP_VERSION_STALE') %}
                                <span class="badge bg-secondary ms-1">Running from branch</span>
                            {% elif config.get('APP_VERSION') != 'unknown' %}
                                <span class="badge bg-info ms-1">Update available</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                    <tr><td class="text-muted">GitHub</td><td><a href="https://github.com/{{ config.get('GITHUB_REPO', '') }}" target="_blank">{{ config.get('GITHUB_REPO', '') }}</a></td></tr>
                </table>
                <form method="post" action="/settings/app-update-mode">
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" name="app_auto_update" id="appAutoUpdate" {{ 'checked' if settings.app_auto_update == 'true' }}>
                        <label class="form-check-label" for="appAutoUpdate"><strong>Enable automatic updates</strong></label>
                        <div class="form-text">When enabled, the app will check for new releases every 6 hours and automatically update and restart.</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Update Branch</label>
                        <input type="text" class="form-control form-control-sm font-monospace" name="app_update_branch" value="{{ settings.app_update_branch or '' }}" placeholder="Leave blank for release-based updates">
                        <div class="form-text">Set a branch name (e.g. <code>main</code>, <code>dev</code>) to pull updates from that branch instead of GitHub releases. Leave blank to use tagged releases.</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary btn-sm">Save</button>
                        <button type="submit" formaction="/settings/check-update" class="btn btn-outline-info btn-sm">
                            <i class="bi bi-arrow-repeat"></i> Check for Updates
                        </button>
                    </div>
                </form>
                {% if update_available %}
                <div class="alert alert-info mt-3 mb-0">
                    <strong>Update available:</strong> {{ update_version }}
                    <form method="post" action="/settings/apply-update" class="mt-2">
                        <button type="submit" class="btn btn-sm btn-info" onclick="return confirm('This will update the application and restart the service. Continue?')">
                            <i class="bi bi-download"></i> Update Now
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}
