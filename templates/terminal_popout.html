<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ guest.name }} - Terminal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
            background: #0d1117;
        }
        #toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 10px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            height: 36px;
            -webkit-app-region: drag;
        }
        #toolbar .btn, #toolbar .badge {
            -webkit-app-region: no-drag;
        }
        #terminal-container {
            position: absolute;
            top: 36px;
            left: 0;
            right: 0;
            bottom: 0;
            padding: 2px;
        }
        #terminal-container .xterm {
            height: 100%;
        }
    </style>
</head>
<body>
    <div id="toolbar">
        <div>
            <span class="text-light small fw-bold">
                <i class="bi bi-terminal"></i> {{ guest.name }}
                <span class="text-muted">({{ resolved_ip or 'no IP' }})</span>
            </span>
            <span id="connStatus" class="badge bg-warning ms-2">Connecting...</span>
        </div>
        <div>
            {% if has_sudo_password %}
            <button id="btnSudo" class="btn btn-sm btn-outline-warning py-0 px-1" onclick="sendSudo()" title="Send stored sudo password">
                <i class="bi bi-shield-lock"></i>
            </button>
            {% endif %}
            <button class="btn btn-sm btn-outline-danger py-0 px-1" onclick="disconnect()" title="Disconnect">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    </div>

    <div id="terminal-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.min.js"></script>
    <script>
    (function() {
        const term = new Terminal({
            cursorBlink: true,
            fontSize: 14,
            fontFamily: '"Cascadia Code", "Fira Code", "JetBrains Mono", monospace',
            theme: {
                background: '#0d1117',
                foreground: '#c9d1d9',
                cursor: '#58a6ff',
                selectionBackground: '#264f78',
                black: '#0d1117',
                red: '#ff7b72',
                green: '#7ee787',
                yellow: '#d29922',
                blue: '#58a6ff',
                magenta: '#bc8cff',
                cyan: '#39c5cf',
                white: '#c9d1d9',
            }
        });

        const fitAddon = new FitAddon.FitAddon();
        const webLinksAddon = new WebLinksAddon.WebLinksAddon();

        term.loadAddon(fitAddon);
        term.loadAddon(webLinksAddon);
        term.open(document.getElementById('terminal-container'));
        fitAddon.fit();

        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/terminal/{{ guest.id }}`;
        let ws = null;

        function connect() {
            ws = new WebSocket(wsUrl);

            ws.onopen = function() {
                term.writeln('\x1b[33mConnecting to {{ guest.name }} ({{ resolved_ip or "..." }})...\x1b[0m');
                ws.send(JSON.stringify({type: 'resize', cols: term.cols, rows: term.rows}));
            };

            ws.onmessage = function(event) {
                const msg = JSON.parse(event.data);
                switch (msg.type) {
                    case 'connected':
                        document.getElementById('connStatus').className = 'badge bg-success';
                        document.getElementById('connStatus').textContent = 'Connected';
                        document.title = '{{ guest.name }} - Connected';
                        break;
                    case 'output':
                        term.write(msg.data);
                        break;
                    case 'error':
                        term.writeln('\x1b[31m' + msg.data + '\x1b[0m');
                        document.getElementById('connStatus').className = 'badge bg-danger';
                        document.getElementById('connStatus').textContent = 'Error';
                        break;
                    case 'disconnected':
                        term.writeln('\r\n\x1b[33m' + msg.data + '\x1b[0m');
                        document.getElementById('connStatus').className = 'badge bg-secondary';
                        document.getElementById('connStatus').textContent = 'Disconnected';
                        document.title = '{{ guest.name }} - Disconnected';
                        break;
                }
            };

            ws.onclose = function() {
                document.getElementById('connStatus').className = 'badge bg-secondary';
                document.getElementById('connStatus').textContent = 'Disconnected';
                term.writeln('\r\n\x1b[33mConnection closed.\x1b[0m');
            };

            ws.onerror = function() {
                document.getElementById('connStatus').className = 'badge bg-danger';
                document.getElementById('connStatus').textContent = 'Error';
            };
        }

        term.onData(function(data) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({type: 'input', data: data}));
            }
        });

        window.addEventListener('resize', function() {
            fitAddon.fit();
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({type: 'resize', cols: term.cols, rows: term.rows}));
            }
        });

        window.disconnect = function() {
            if (ws) ws.close();
        };

        window.sendSudo = function() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({type: 'sudo'}));
            }
        };

        {% if resolved_ip %}
        connect();
        {% else %}
        term.writeln('\x1b[31mCould not resolve IP address for this guest.\x1b[0m');
        document.getElementById('connStatus').className = 'badge bg-danger';
        document.getElementById('connStatus').textContent = 'No IP';
        {% endif %}
    })();
    </script>
</body>
</html>
