{% extends "base.html" %}
{% block title %}Updating - Mastodon Canada Administration Tool{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card bg-dark">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-arrow-repeat" id="spinIcon"></i> Application Update</h5>
                <span id="statusBadge" class="badge bg-info">Starting...</span>
            </div>
            <div class="card-body p-0">
                <pre id="logOutput" style="background: #1a1a2e; color: #e0e0e0; padding: 1rem; margin: 0; min-height: 300px; max-height: 500px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap; word-wrap: break-word; border-radius: 0;"></pre>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center">
                <small class="text-muted" id="statusText">Waiting for update output...</small>
                <a href="/settings" id="backBtn" class="btn btn-secondary btn-sm disabled">
                    <i class="bi bi-arrow-left"></i> Back to Settings
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    const logEl = document.getElementById('logOutput');
    const badge = document.getElementById('statusBadge');
    const statusText = document.getElementById('statusText');
    const backBtn = document.getElementById('backBtn');
    const spinIcon = document.getElementById('spinIcon');

    let wasRunning = true;
    let connectionLost = false;
    let processDone = false;
    let processDoneAt = 0;
    let updateComplete = false;
    let pollInterval = 2000;

    function setStatus(text, badgeClass, badgeText) {
        statusText.textContent = text;
        badge.className = 'badge ' + badgeClass;
        badge.textContent = badgeText;
    }

    function markComplete(data) {
        updateComplete = true;
        if (data && data.log) {
            logEl.textContent = data.log;
        }
        logEl.textContent += '\n--- Update complete ---\n';
        logEl.scrollTop = logEl.scrollHeight;
        setStatus('Update complete!', 'bg-success', 'Complete');
        backBtn.classList.remove('disabled');
        backBtn.removeAttribute('aria-disabled');
        spinIcon.classList.remove('spin-animation');
    }

    async function poll() {
        if (updateComplete) return;

        try {
            const resp = await fetch('/settings/update-status', { cache: 'no-store' });
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            const data = await resp.json();

            // Connection restored after being lost = service restarted
            if (connectionLost) {
                markComplete(data);
                return;
            }

            // Update log
            if (data.log) {
                logEl.textContent = data.log;
                logEl.scrollTop = logEl.scrollHeight;
            }

            if (data.running) {
                setStatus('Update in progress...', 'bg-info', 'Updating...');
                wasRunning = true;
                processDone = false;
            } else {
                if (wasRunning) {
                    // Process just finished — wait for service restart
                    setStatus('Service restarting, please wait...', 'bg-warning text-dark', 'Restarting...');
                    wasRunning = false;
                    processDone = true;
                    processDoneAt = Date.now();
                }

                // If process has been done for >10s and we're still connected,
                // the service either restarted fast or won't restart (e.g. dev mode).
                // Either way, the update is done.
                if (processDone && (Date.now() - processDoneAt) > 10000) {
                    markComplete(data);
                    return;
                }
            }

        } catch (e) {
            // Connection failed — service is restarting
            connectionLost = true;
            setStatus('Service restarting, please wait...', 'bg-warning text-dark', 'Restarting...');
        }

        setTimeout(poll, pollInterval);
    }

    // Add spin animation
    const style = document.createElement('style');
    style.textContent = '.spin-animation { animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
    document.head.appendChild(style);
    spinIcon.classList.add('spin-animation');

    // Start polling
    setTimeout(poll, 1000);
})();
</script>
{% endblock %}
