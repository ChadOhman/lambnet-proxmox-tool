{% extends "base.html" %}
{% block title %}{{ guest.name }} - Mastodon Canada Administration Tool{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/guests">Guests</a></li>
        <li class="breadcrumb-item active">{{ guest.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>
            {% if guest.power_state == 'running' %}
            <span class="text-success"><i class="bi bi-circle-fill"></i></span>
            {% elif guest.power_state == 'stopped' %}
            <span class="text-danger"><i class="bi bi-circle-fill"></i></span>
            {% elif guest.power_state == 'paused' %}
            <span class="text-warning"><i class="bi bi-pause-circle-fill"></i></span>
            {% else %}
            <span class="text-muted"><i class="bi bi-circle"></i></span>
            {% endif %}
            {{ guest.name }}
            <span class="badge bg-{{ 'primary' if guest.guest_type == 'vm' else 'success' }}">{{ guest.guest_type|upper }}</span>
        </h2>
    </div>
    <div>
        {% if guest.ip_address and (current_user.can_ssh or current_user.can_manage_guests) %}
        <a href="/terminal/{{ guest.id }}" class="btn btn-outline-success">
            <i class="bi bi-terminal"></i> SSH
        </a>
        {% endif %}
        <form method="post" action="/api/scan/{{ guest.id }}" class="d-inline">
            <button type="submit" class="btn btn-outline-primary"><i class="bi bi-arrow-clockwise"></i> Scan</button>
        </form>
        {% if guest.pending_updates()|length > 0 %}
        <form method="post" action="/api/apply/{{ guest.id }}" class="d-inline" onsubmit="return confirm('Apply all updates?')">
            <button type="submit" class="btn btn-warning"><i class="bi bi-download"></i> Apply All Updates</button>
        </form>
        {% endif %}
        <form method="post" action="/guests/{{ guest.id }}/delete" class="d-inline" onsubmit="return confirm('Delete this guest?')">
            <button type="submit" class="btn btn-outline-danger"><i class="bi bi-trash"></i></button>
        </form>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="card bg-dark">
            <div class="card-header"><h5 class="mb-0">Guest Info</h5></div>
            <div class="card-body">
                <table class="table table-dark table-sm mb-0">
                    <tr>
                        <td class="text-muted" style="width:40%">IP Address</td>
                        <td>
                            {%- if guest.ip_address and guest.ip_address != 'dhcp' -%}
                                {{ guest.ip_address }}
                            {%- elif unifi_client -%}
                                {{ unifi_client.ip }} <span class="text-info"><i class="bi bi-router"></i> UniFi</span>
                            {%- else -%}
                                <span class="text-muted">Not set</span>
                            {%- endif -%}
                        </td>
                    </tr>
                    <tr><td class="text-muted">MAC Address</td><td><code>{{ guest.mac_address or 'Unknown' }}</code></td></tr>
                    <tr><td class="text-muted">VMID</td><td>{{ guest.vmid or 'N/A' }}</td></tr>
                    <tr><td class="text-muted">Host</td><td>{{ guest.proxmox_host.name if guest.proxmox_host else 'Standalone' }}</td></tr>
                    <tr><td class="text-muted">Connection</td><td>{{ guest.connection_method }}</td></tr>
                    <tr><td class="text-muted">Credential</td><td>{{ guest.credential.name if guest.credential else 'Default' }}</td></tr>
                    <tr><td class="text-muted">Auto-Update</td><td>{{ 'Enabled' if guest.auto_update else 'Disabled' }}</td></tr>
                    <tr>
                        <td class="text-muted">Replication</td>
                        <td>
                            {% if guest.replication_target %}
                            <span class="text-info"><i class="bi bi-arrow-repeat"></i> {{ guest.replication_target }}</span>
                            {% else %}
                            <span class="text-muted">None</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr><td class="text-muted">Last Scan</td><td>{{ guest.last_scan.strftime('%Y-%m-%d %H:%M:%S') if guest.last_scan else 'Never' }}</td></tr>
                    <tr>
                        <td class="text-muted">Tags</td>
                        <td>
                            {% for tag in guest.tags %}
                            <span class="badge" style="background-color: {{ tag.color }};">{{ tag.name }}</span>
                            {% else %}
                            <span class="text-muted">None</span>
                            {% endfor %}
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-dark">
            <div class="card-header"><h5 class="mb-0">Edit Guest</h5></div>
            <div class="card-body">
                <form method="post" action="/guests/{{ guest.id }}/edit">
                    <div class="mb-2">
                        <label class="form-label form-label-sm">IP Address</label>
                        <input type="text" class="form-control form-control-sm" name="ip_address" value="{{ guest.ip_address or '' }}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label form-label-sm">Connection Method</label>
                        <select class="form-select form-select-sm" name="connection_method">
                            <option value="ssh" {{ 'selected' if guest.connection_method == 'ssh' }}>SSH</option>
                            <option value="agent" {{ 'selected' if guest.connection_method == 'agent' }}>QEMU Agent</option>
                            <option value="auto" {{ 'selected' if guest.connection_method == 'auto' }}>Auto</option>
                        </select>
                    </div>
                    <div class="mb-2">
                        <label class="form-label form-label-sm">Credential</label>
                        <select class="form-select form-select-sm" name="credential_id">
                            <option value="">Use default</option>
                            {% for cred in credentials %}
                            <option value="{{ cred.id }}" {{ 'selected' if guest.credential_id == cred.id }}>{{ cred.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" name="auto_update" id="autoUpdate" {{ 'checked' if guest.auto_update }}>
                        <label class="form-check-label" for="autoUpdate">Enable Auto-Update</label>
                    </div>
                    <div class="mb-2">
                        <label class="form-label form-label-sm">Require Snapshot</label>
                        <select class="form-select form-select-sm" name="require_snapshot">
                            <option value="inherit" {{ 'selected' if guest.require_snapshot == 'inherit' }}>Inherit (global setting)</option>
                            <option value="yes" {{ 'selected' if guest.require_snapshot == 'yes' }}>Yes</option>
                            <option value="no" {{ 'selected' if guest.require_snapshot == 'no' }}>No</option>
                        </select>
                    </div>
                    {% if current_user.can_manage_guests %}
                    <div class="mb-2">
                        <label class="form-label form-label-sm">Tags</label>
                        {% set guest_tag_ids = guest.tags | map(attribute='id') | list %}
                        {% for tag in tags %}
                        <div class="form-check form-check-inline">
                            <input type="checkbox" class="form-check-input" name="tag_ids" value="{{ tag.id }}" {{ 'checked' if tag.id in guest_tag_ids }}>
                            <label class="form-check-label"><span class="badge" style="background-color: {{ tag.color }};">{{ tag.name }}</span></label>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <button type="submit" class="btn btn-sm btn-primary">Save Changes</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% if current_user.can_manage_guests and guest.proxmox_host and guest.vmid %}
<div class="card bg-dark mb-4">
    <div class="card-header"><h5 class="mb-0"><i class="bi bi-power"></i> Power Management</h5></div>
    <div class="card-body">
        <div class="d-flex align-items-center gap-3">
            <span class="me-2">
                {% if guest.power_state == 'running' %}
                <span class="badge bg-success">Running</span>
                {% elif guest.power_state == 'stopped' %}
                <span class="badge bg-danger">Stopped</span>
                {% elif guest.power_state == 'paused' %}
                <span class="badge bg-warning">Paused</span>
                {% else %}
                <span class="badge bg-secondary">Unknown</span>
                {% endif %}
            </span>
            {% if guest.power_state != 'running' %}
            <form method="post" action="/guests/{{ guest.id }}/power/start" class="d-inline">
                <button type="submit" class="btn btn-sm btn-success"><i class="bi bi-play-fill"></i> Start</button>
            </form>
            {% endif %}
            {% if guest.power_state == 'running' %}
            <form method="post" action="/guests/{{ guest.id }}/power/shutdown" class="d-inline" onsubmit="return confirm('Gracefully shutdown {{ guest.name }}?')">
                <button type="submit" class="btn btn-sm btn-warning"><i class="bi bi-stop-fill"></i> Shutdown</button>
            </form>
            <form method="post" action="/guests/{{ guest.id }}/power/reboot" class="d-inline" onsubmit="return confirm('Reboot {{ guest.name }}?')">
                <button type="submit" class="btn btn-sm btn-outline-warning"><i class="bi bi-arrow-clockwise"></i> Reboot</button>
            </form>
            <form method="post" action="/guests/{{ guest.id }}/power/stop" class="d-inline" onsubmit="return confirm('Force stop {{ guest.name }}? This may cause data loss.')">
                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-x-circle"></i> Force Stop</button>
            </form>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

{% if guest.proxmox_host and guest.vmid %}
<div class="card bg-dark mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-graph-up"></i> Performance</h5>
        <div class="btn-group btn-group-sm" id="perfTimeframe">
            <button class="btn btn-outline-secondary active" data-tf="day">1 Day</button>
            <button class="btn btn-outline-secondary" data-tf="week">7 Days</button>
            <button class="btn btn-outline-secondary" data-tf="month">30 Days</button>
        </div>
    </div>
    <div class="card-body">
        {% if hardware %}
        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <div class="d-flex align-items-center">
                    <i class="bi bi-cpu text-primary me-2" style="font-size: 1.5rem;"></i>
                    <div>
                        <div class="text-muted small">CPU</div>
                        <strong>{{ hardware.vcpus }} vCPU{{ 's' if hardware.vcpus != 1 }}</strong>
                        {% if hardware.sockets > 1 %}
                        <span class="text-muted small">({{ hardware.sockets }}s &times; {{ hardware.cores }}c)</span>
                        {% endif %}
                        {% if hardware.cpu_type %}
                        <span class="text-muted small">{{ hardware.cpu_type }}</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex align-items-center">
                    <i class="bi bi-memory text-success me-2" style="font-size: 1.5rem;"></i>
                    <div>
                        <div class="text-muted small">Memory</div>
                        {% set mem_mb = hardware.memory_mb | int %}
                        {% if mem_mb >= 1024 %}
                        <strong>{{ "%.1f"|format(mem_mb / 1024) }} GB</strong>
                        {% else %}
                        <strong>{{ mem_mb }} MB</strong>
                        {% endif %}
                        {% if hardware.balloon is not none and hardware.balloon != hardware.memory_mb %}
                        <span class="text-muted small">(balloon: {{ hardware.balloon }} MB)</span>
                        {% endif %}
                        {% if hardware.swap_mb %}
                        <span class="text-muted small">+ {{ hardware.swap_mb }} MB swap</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="d-flex align-items-center">
                    <i class="bi bi-device-hdd text-warning me-2" style="font-size: 1.5rem;"></i>
                    <div>
                        <div class="text-muted small">Disks</div>
                        {% if hardware.disks %}
                        {% for disk in hardware.disks %}
                        <span class="me-2">
                            <strong>{{ disk.size | default('?') }}</strong>
                            <span class="text-muted small">{{ disk.key }}{% if disk.get('storage') %} ({{ disk.storage }}){% endif %}</span>
                        </span>
                        {% endfor %}
                        {% else %}
                        <span class="text-muted">No disks found</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        <hr class="border-secondary my-2">
        {% endif %}
        <div id="perfLoading" class="text-center text-muted py-4">
            <div class="spinner-border spinner-border-sm me-2" role="status"></div>Loading performance data...
        </div>
        <div id="perfError" class="text-center text-muted py-4 d-none"></div>
        <div id="perfCharts" class="d-none">
            <div class="row g-3">
                <div class="col-md-4">
                    <h6 class="text-center text-muted mb-1">CPU Usage</h6>
                    <canvas id="cpuChart"></canvas>
                </div>
                <div class="col-md-4">
                    <h6 class="text-center text-muted mb-1">Memory Usage</h6>
                    <canvas id="memChart"></canvas>
                </div>
                <div class="col-md-4">
                    <h6 class="text-center text-muted mb-1">Network I/O</h6>
                    <canvas id="netChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if current_user.can_manage_guests and (guest.services or True) %}
<div class="card bg-dark mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-gear-wide-connected"></i> Services</h5>
        <div class="d-flex gap-2">
            <form method="post" action="/services/refresh" class="d-inline">
                <button type="submit" class="btn btn-sm btn-outline-primary"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
            </form>
            <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="bi bi-plus-lg"></i> Assign
                </button>
                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                    {% set assigned = guest.services | map(attribute='service_name') | list %}
                    {% for key, info in known_services.items() %}
                    {% if key not in assigned %}
                    <li>
                        <form method="post" action="/services/{{ guest.id }}/assign" class="d-inline">
                            <input type="hidden" name="service_key" value="{{ key }}">
                            <button type="submit" class="dropdown-item">{{ info[0] }}</button>
                        </form>
                    </li>
                    {% endif %}
                    {% endfor %}
                    {% if assigned|length >= known_services|length %}
                    <li><span class="dropdown-item text-muted">All services assigned</span></li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if guest.services %}
        <table class="table table-dark table-sm mb-0">
            <thead>
                <tr>
                    <th>Status</th>
                    <th>Service</th>
                    <th>Port</th>
                    <th>Last Checked</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for svc in guest.services %}
                <tr>
                    <td>
                        {% if svc.status == 'running' %}
                        <span class="text-success" title="Running"><i class="bi bi-circle-fill"></i></span>
                        {% elif svc.status == 'stopped' %}
                        <span class="text-danger" title="Stopped"><i class="bi bi-circle-fill"></i></span>
                        {% elif svc.status == 'failed' %}
                        <span class="text-danger" title="Failed"><i class="bi bi-exclamation-circle-fill"></i></span>
                        {% else %}
                        <span class="text-muted" title="Unknown"><i class="bi bi-circle"></i></span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="/services/{{ svc.id }}/detail" class="text-light text-decoration-none">{{ svc.service_name|capitalize }}</a>
                        {% if svc.auto_detected %}<span class="badge bg-info">Auto</span>{% endif %}
                    </td>
                    <td>{{ svc.port or '-' }}</td>
                    <td>
                        {% if svc.last_checked %}
                        {{ svc.last_checked.strftime('%m/%d %H:%M') }}
                        {% else %}
                        <span class="text-muted">Never</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            {% if svc.status != 'running' %}
                            <form method="post" action="/services/{{ svc.id }}/start" class="d-inline">
                                <button type="submit" class="btn btn-outline-success" title="Start"><i class="bi bi-play-fill"></i></button>
                            </form>
                            {% endif %}
                            {% if svc.status == 'running' %}
                            <form method="post" action="/services/{{ svc.id }}/stop" class="d-inline" onsubmit="return confirm('Stop {{ svc.service_name }} on {{ guest.name }}?')">
                                <button type="submit" class="btn btn-outline-danger" title="Stop"><i class="bi bi-stop-fill"></i></button>
                            </form>
                            {% endif %}
                            <form method="post" action="/services/{{ svc.id }}/restart" class="d-inline" onsubmit="return confirm('Restart {{ svc.service_name }} on {{ guest.name }}?')">
                                <button type="submit" class="btn btn-outline-warning" title="Restart"><i class="bi bi-arrow-clockwise"></i></button>
                            </form>
                            <button type="button" class="btn btn-outline-light" title="Logs" onclick="fetchLogs({{ svc.id }})">
                                <i class="bi bi-journal-text"></i>
                            </button>
                            <form method="post" action="/services/{{ svc.id }}/remove" class="d-inline" onsubmit="return confirm('Remove {{ svc.service_name }}?')">
                                <button type="submit" class="btn btn-outline-danger" title="Remove"><i class="bi bi-trash"></i></button>
                            </form>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="card-body">
            <p class="text-muted mb-0">No services assigned. Use the Assign button above or run a scan to auto-detect services.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if current_user.can_manage_guests and guest.proxmox_host and guest.vmid and cluster_nodes|length > 1 %}
<div class="card bg-dark mb-4">
    <div class="card-header"><h5 class="mb-0"><i class="bi bi-arrow-repeat"></i> Replication</h5></div>
    <div class="card-body">
        {% if repl_jobs %}
        <table class="table table-dark table-sm mb-3">
            <thead>
                <tr>
                    <th>Job ID</th>
                    <th>Target</th>
                    <th>Schedule</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for job in repl_jobs %}
                <tr>
                    <td><code>{{ job.id }}</code></td>
                    <td>{{ job.target }}</td>
                    <td><code>{{ job.schedule or '*/15' }}</code></td>
                    <td>
                        <form method="post" action="/guests/{{ guest.id }}/replication/{{ job.id }}/delete" class="d-inline" onsubmit="return confirm('Remove replication to {{ job.target }}?')">
                            <button type="submit" class="btn btn-outline-danger btn-sm"><i class="bi bi-trash"></i> Remove</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-muted mb-3">No replication jobs configured for this guest.</p>
        {% endif %}

        {% set current_node = guest.proxmox_host.name %}
        {% set available_targets = [] %}
        {% for n in cluster_nodes if n != (guest.replication_target or '') %}
        {% if n != current_node or repl_jobs|length == 0 %}
        {% set _ = available_targets.append(n) %}
        {% endif %}
        {% endfor %}

        <form method="post" action="/guests/{{ guest.id }}/replication" class="row g-2 align-items-end">
            <div class="col-auto">
                <label class="form-label form-label-sm">Target Node</label>
                <select class="form-select form-select-sm" name="target_node" required>
                    {% for n in cluster_nodes %}
                    <option value="{{ n }}">{{ n }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-auto">
                <label class="form-label form-label-sm">Schedule</label>
                <select class="form-select form-select-sm" name="schedule">
                    <option value="*/15">Every 15 min</option>
                    <option value="*/30">Every 30 min</option>
                    <option value="0 *">Every hour</option>
                    <option value="0 */2">Every 2 hours</option>
                    <option value="0 */6">Every 6 hours</option>
                </select>
            </div>
            <div class="col-auto">
                <button type="submit" class="btn btn-sm btn-info"><i class="bi bi-plus-lg"></i> Enable Replication</button>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% if guest.proxmox_host and guest.vmid %}
<div class="card bg-dark mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-camera"></i> Snapshots</h5>
        {% if current_user.can_manage_guests %}
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#createSnapshotForm">
            <i class="bi bi-plus-lg"></i> Create Snapshot
        </button>
        {% endif %}
    </div>
    <div class="card-body">
        {% if current_user.can_manage_guests %}
        <div class="collapse mb-3" id="createSnapshotForm">
            <form method="post" action="/guests/{{ guest.id }}/snapshot/create" class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label form-label-sm">Name <small class="text-muted">(optional)</small></label>
                    <input type="text" class="form-control form-control-sm" name="snapname" placeholder="auto-generated if blank">
                </div>
                <div class="col-md-5">
                    <label class="form-label form-label-sm">Description</label>
                    <input type="text" class="form-control form-control-sm" name="description" placeholder="Optional description">
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-sm btn-primary w-100"><i class="bi bi-camera"></i> Create</button>
                </div>
            </form>
        </div>
        {% endif %}
        {% if snapshots %}
        <div class="table-responsive">
            <table class="table table-dark table-sm mb-0">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Date</th>
                        {% if current_user.can_manage_guests %}
                        <th>Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for snap in snapshots %}
                    <tr>
                        <td><code>{{ snap.name }}</code></td>
                        <td>{{ snap.description or '' }}</td>
                        <td>
                            {% if snap.snaptime %}
                            {{ snap.snaptime | int | timestamp_to_datetime }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        {% if current_user.can_manage_guests %}
                        <td>
                            <form method="post" action="/guests/{{ guest.id }}/snapshot/{{ snap.name }}/rollback" class="d-inline" onsubmit="return confirm('Rollback {{ guest.name }} to snapshot {{ snap.name }}? This will revert the guest to that point in time.')">
                                <button type="submit" class="btn btn-outline-warning btn-sm" title="Rollback"><i class="bi bi-arrow-counterclockwise"></i></button>
                            </form>
                            <form method="post" action="/guests/{{ guest.id }}/snapshot/{{ snap.name }}/delete" class="d-inline" onsubmit="return confirm('Delete snapshot {{ snap.name }}?')">
                                <button type="submit" class="btn btn-outline-danger btn-sm" title="Delete"><i class="bi bi-trash"></i></button>
                            </form>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted mb-0">No snapshots found for this guest.</p>
        {% endif %}
    </div>
</div>
{% endif %}

{% if guest.proxmox_host and guest.vmid %}
<div class="card bg-dark mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0"><i class="bi bi-hdd"></i> Backups</h5>
        {% if current_user.can_manage_guests %}
        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="collapse" data-bs-target="#createBackupForm">
            <i class="bi bi-plus-lg"></i> Create Backup
        </button>
        {% endif %}
    </div>
    <div class="card-body">
        {% if current_user.can_manage_guests %}
        <div class="collapse mb-3" id="createBackupForm">
            <form method="post" action="/guests/{{ guest.id }}/backup/create">
                <div class="row g-2 align-items-end">
                    <div class="col-md-3">
                        <label class="form-label form-label-sm">Storage</label>
                        <select class="form-select form-select-sm" name="storage">
                            <option value="">Default</option>
                            {% for st in backup_storages %}
                            <option value="{{ st.storage }}">{{ st.storage }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label form-label-sm">Mode</label>
                        <select class="form-select form-select-sm" name="mode">
                            <option value="">Default</option>
                            <option value="snapshot">Snapshot</option>
                            <option value="suspend">Suspend</option>
                            <option value="stop">Stop</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label form-label-sm">Compression</label>
                        <select class="form-select form-select-sm" name="compress">
                            <option value="">Default</option>
                            <option value="zstd">ZSTD</option>
                            <option value="lzo">LZO</option>
                            <option value="gzip">GZIP</option>
                            <option value="0">None</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label form-label-sm">Notes</label>
                        <input type="text" class="form-control form-control-sm" name="notes" placeholder="Optional notes">
                    </div>
                    <div class="col-md-2">
                        <div class="form-check mb-1">
                            <input type="checkbox" class="form-check-input" name="protected" id="backupProtected">
                            <label class="form-check-label small" for="backupProtected">Protected</label>
                        </div>
                        <button type="submit" class="btn btn-sm btn-primary w-100"><i class="bi bi-hdd"></i> Backup</button>
                    </div>
                </div>
            </form>
        </div>
        {% endif %}
        {% if backups %}
        <div class="table-responsive">
            <table class="table table-dark table-sm mb-0">
                <thead>
                    <tr>
                        <th>Volume</th>
                        <th>Size</th>
                        <th>Date</th>
                        <th>Notes</th>
                        <th>Protected</th>
                        {% if current_user.can_manage_guests %}
                        <th>Actions</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for backup in backups %}
                    <tr>
                        <td><code class="small">{{ backup.volid.split(':')[1] if ':' in backup.volid else backup.volid }}</code></td>
                        <td>
                            {% set sz = backup.size | default(0) | int %}
                            {% if sz >= 1073741824 %}{{ "%.1f"|format(sz / 1073741824) }} GB
                            {% elif sz >= 1048576 %}{{ "%.1f"|format(sz / 1048576) }} MB
                            {% elif sz > 0 %}{{ "%.1f"|format(sz / 1024) }} KB
                            {% else %}-{% endif %}
                        </td>
                        <td>
                            {% if backup.ctime %}
                            {{ backup.ctime | int | timestamp_to_datetime }}
                            {% else %}-{% endif %}
                        </td>
                        <td class="small">{{ backup.notes | default('', true) | truncate(50) }}</td>
                        <td>
                            {% if backup.protected | default(false) %}
                            <span class="badge bg-success"><i class="bi bi-lock-fill"></i> Yes</span>
                            {% else %}
                            <span class="text-muted">No</span>
                            {% endif %}
                        </td>
                        {% if current_user.can_manage_guests %}
                        <td>
                            <div class="btn-group btn-group-sm">
                                {% if backup.protected | default(false) %}
                                <form method="post" action="/guests/{{ guest.id }}/backup/{{ backup.volid }}/protect" class="d-inline">
                                    <input type="hidden" name="protected" value="0">
                                    <button type="submit" class="btn btn-outline-warning" title="Unprotect"><i class="bi bi-unlock"></i></button>
                                </form>
                                {% else %}
                                <form method="post" action="/guests/{{ guest.id }}/backup/{{ backup.volid }}/protect" class="d-inline">
                                    <input type="hidden" name="protected" value="1">
                                    <button type="submit" class="btn btn-outline-success" title="Protect"><i class="bi bi-lock"></i></button>
                                </form>
                                {% endif %}
                                <form method="post" action="/guests/{{ guest.id }}/backup/{{ backup.volid }}/delete" class="d-inline" onsubmit="return confirm('Delete this backup? This cannot be undone.')">
                                    <button type="submit" class="btn btn-outline-danger" title="Delete"><i class="bi bi-trash"></i></button>
                                </form>
                            </div>
                        </td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted mb-0">No backups found for this guest.</p>
        {% endif %}
    </div>
</div>
{% endif %}

{% if unifi_client and current_user.can_manage_guests %}
<div class="card bg-dark mb-4">
    <div class="card-header"><h5 class="mb-0"><i class="bi bi-router"></i> UniFi Network</h5></div>
    <div class="card-body">
        <table class="table table-dark table-sm mb-3">
            <tr><td class="text-muted" style="width:40%">IP Address</td><td>{{ unifi_client.ip }}</td></tr>
            <tr><td class="text-muted">MAC Address</td><td><code>{{ unifi_client.mac }}</code></td></tr>
            <tr><td class="text-muted">Network</td><td>{{ unifi_client.network or 'Unknown' }}</td></tr>
            <tr>
                <td class="text-muted">Connection</td>
                <td>
                    {% if unifi_client.is_wired %}
                    <i class="bi bi-ethernet"></i> Wired
                    {% else %}
                    <i class="bi bi-wifi"></i> Wireless
                    {% if unifi_client.signal %}<span class="text-muted ms-1">({{ unifi_client.signal }} dBm)</span>{% endif %}
                    {% endif %}
                </td>
            </tr>
            <tr>
                <td class="text-muted">Uptime</td>
                <td>
                    {% set ut = unifi_client.uptime | int %}
                    {% if ut > 86400 %}{{ (ut // 86400) }}d {{ (ut % 86400 // 3600) }}h
                    {% elif ut > 3600 %}{{ (ut // 3600) }}h {{ (ut % 3600 // 60) }}m
                    {% elif ut > 0 %}{{ (ut // 60) }}m
                    {% else %}-{% endif %}
                </td>
            </tr>
            <tr>
                <td class="text-muted">Last Polled</td>
                <td>
                    {% if unifi_last_polled %}
                    {{ unifi_last_polled[:19] | replace('T', ' ') }} UTC
                    {% else %}
                    <span class="text-muted">Unknown</span>
                    {% endif %}
                </td>
            </tr>
        </table>
        <div class="d-flex gap-2">
            {% if not unifi_client.is_wired %}
            <form method="post" action="/guests/{{ guest.id }}/unifi/reconnect" class="d-inline" onsubmit="return confirm('Force reconnect {{ guest.name }}?')">
                <button type="submit" class="btn btn-sm btn-outline-warning"><i class="bi bi-arrow-clockwise"></i> Reconnect</button>
            </form>
            {% endif %}
            <form method="post" action="/guests/{{ guest.id }}/unifi/block" class="d-inline" onsubmit="return confirm('Block {{ guest.name }} from the network?')">
                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-slash-circle"></i> Block</button>
            </form>
        </div>
    </div>
</div>
{% elif guest.mac_address and not unifi_client and current_user.can_manage_guests %}
<div class="card bg-dark mb-4">
    <div class="card-header"><h5 class="mb-0"><i class="bi bi-router"></i> UniFi Network</h5></div>
    <div class="card-body">
        <p class="text-muted mb-0">Guest MAC <code>{{ guest.mac_address }}</code> not found on UniFi network (offline or not connected).
            {% if unifi_last_polled %}<br><small>Last polled: {{ unifi_last_polled[:19] | replace('T', ' ') }} UTC</small>{% endif %}
        </p>
    </div>
</div>
{% endif %}

<div class="card bg-dark">
    <div class="card-header">
        <h5 class="mb-0"><i class="bi bi-box-seam"></i> Pending Updates ({{ guest.pending_updates()|length }})</h5>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark table-hover mb-0">
                <thead>
                    <tr>
                        <th>Package</th>
                        <th>Current Version</th>
                        <th>Available Version</th>
                        <th>Severity</th>
                        <th>Discovered</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pkg in guest.pending_updates() %}
                    <tr>
                        <td>{{ pkg.package_name }}</td>
                        <td><code>{{ pkg.current_version }}</code></td>
                        <td><code>{{ pkg.available_version }}</code></td>
                        <td>
                            <span class="badge badge-{{ pkg.severity }}">{{ pkg.severity }}</span>
                        </td>
                        <td>{{ pkg.discovered_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="text-center text-muted py-3">No pending updates</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Logs Modal -->
<div class="modal fade" id="logsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="logsModalTitle">Service Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="logsContent" class="bg-black text-light p-3 rounded" style="max-height: 400px; overflow-y: auto; font-size: 0.85rem; white-space: pre-wrap;">Loading...</pre>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// --- Performance Charts ---
(function() {
    if (!document.getElementById('cpuChart')) return;

    const guestId = {{ guest.id }};
    let cpuChart, memChart, netChart;

    const chartDefaults = {
        responsive: true,
        animation: { duration: 300 },
        scales: {
            x: {
                ticks: { color: '#888', maxTicksLimit: 8, maxRotation: 0 },
                grid: { color: 'rgba(255,255,255,0.05)' }
            },
            y: {
                ticks: { color: '#888' },
                grid: { color: 'rgba(255,255,255,0.08)' },
                beginAtZero: true
            }
        },
        plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false }
        },
        elements: { point: { radius: 0 }, line: { borderWidth: 1.5, tension: 0.3 } },
        interaction: { mode: 'index', intersect: false }
    };

    function makeChart(ctx, label, color, yMax, yCallback) {
        const opts = JSON.parse(JSON.stringify(chartDefaults));
        if (yMax) opts.scales.y.max = yMax;
        if (yCallback) opts.scales.y.ticks.callback = yCallback;
        return new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: label, data: [], borderColor: color, backgroundColor: color + '22', fill: true }] },
            options: opts
        });
    }

    function makeNetChart(ctx) {
        const opts = JSON.parse(JSON.stringify(chartDefaults));
        opts.plugins.legend = { display: true, labels: { color: '#aaa', boxWidth: 12, padding: 8 } };
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    { label: 'In', data: [], borderColor: '#8b5cf6', backgroundColor: '#8b5cf622', fill: true },
                    { label: 'Out', data: [], borderColor: '#f97316', backgroundColor: '#f9731622', fill: true }
                ]
            },
            options: opts
        });
    }

    cpuChart = makeChart(document.getElementById('cpuChart'), 'CPU %', '#3b82f6', 100, v => v + '%');
    memChart = makeChart(document.getElementById('memChart'), 'Memory %', '#10b981', 100, v => v + '%');
    netChart = makeNetChart(document.getElementById('netChart'));

    function loadData(timeframe) {
        document.getElementById('perfLoading').classList.remove('d-none');
        document.getElementById('perfCharts').classList.add('d-none');
        document.getElementById('perfError').classList.add('d-none');

        fetch('/api/guests/' + guestId + '/rrd?timeframe=' + timeframe, { cache: 'no-store' })
            .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(data => {
                document.getElementById('perfLoading').classList.add('d-none');
                if (data.error) {
                    document.getElementById('perfError').textContent = data.error;
                    document.getElementById('perfError').classList.remove('d-none');
                    return;
                }
                if (!data.labels || data.labels.length === 0) {
                    document.getElementById('perfError').textContent = 'No performance data available.';
                    document.getElementById('perfError').classList.remove('d-none');
                    return;
                }
                document.getElementById('perfCharts').classList.remove('d-none');

                // Shorten labels for display
                const labels = data.labels.map(l => {
                    const parts = l.split(' ');
                    return parts.length > 1 ? parts[1] : l;
                });

                cpuChart.data.labels = labels;
                cpuChart.data.datasets[0].data = data.cpu;
                cpuChart.update();

                memChart.data.labels = labels;
                memChart.data.datasets[0].data = data.mem_percent;
                memChart.options.plugins.tooltip.callbacks = {
                    afterLabel: function(ctx) {
                        const mb = data.mem_used_mb[ctx.dataIndex];
                        if (mb == null) return '';
                        if (mb > 1024) return (mb / 1024).toFixed(1) + ' GB / ' + (data.mem_total_mb / 1024).toFixed(1) + ' GB';
                        return mb + ' MB / ' + data.mem_total_mb + ' MB';
                    }
                };
                memChart.update();

                netChart.data.labels = labels;
                netChart.data.datasets[0].data = data.netin;
                netChart.data.datasets[1].data = data.netout;
                netChart.options.scales.y.title = { display: true, text: data.net_unit, color: '#888' };
                netChart.update();
            })
            .catch(err => {
                document.getElementById('perfLoading').classList.add('d-none');
                document.getElementById('perfError').textContent = 'Failed to load performance data.';
                document.getElementById('perfError').classList.remove('d-none');
            });
    }

    // Timeframe button handling
    document.querySelectorAll('#perfTimeframe button').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('#perfTimeframe button').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            loadData(this.dataset.tf);
        });
    });

    // Initial load
    loadData('day');
})();

function fetchLogs(serviceId) {
    const modal = new bootstrap.Modal(document.getElementById('logsModal'));
    document.getElementById('logsContent').textContent = 'Loading...';
    document.getElementById('logsModalTitle').textContent = 'Service Logs';
    modal.show();

    fetch('/services/' + serviceId + '/logs', { method: 'POST' })
        .then(r => r.json())
        .then(data => {
            document.getElementById('logsModalTitle').textContent = data.service + ' on ' + data.guest;
            document.getElementById('logsContent').textContent = data.logs;
            const pre = document.getElementById('logsContent');
            pre.scrollTop = pre.scrollHeight;
        })
        .catch(err => {
            document.getElementById('logsContent').textContent = 'Error fetching logs: ' + err;
        });
}
</script>
{% endblock %}
