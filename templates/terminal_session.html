{% extends "base.html" %}
{% block title %}{{ guest.name }} - Terminal{% endblock %}

{% block content %}
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/terminal">Terminal</a></li>
        <li class="breadcrumb-item active">{{ guest.name }}</li>
    </ol>
</nav>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h4 class="mb-0">
            <i class="bi bi-terminal"></i> {{ guest.name }}
            <small class="text-muted">({{ resolved_ip or 'no IP' }})</small>
        </h4>
    </div>
    <div>
        <span id="connStatus" class="badge bg-warning">Connecting...</span>
        <button id="btnDisconnect" class="btn btn-sm btn-outline-danger ms-2" onclick="disconnect()">
            <i class="bi bi-x-lg"></i> Disconnect
        </button>
    </div>
</div>

{% if needs_credentials %}
<!-- Credential prompt shown when no stored credentials -->
<div id="credentialForm" class="card bg-dark mb-3">
    <div class="card-header border-secondary">
        <i class="bi bi-key"></i> SSH Credentials Required
    </div>
    <div class="card-body">
        <p class="text-muted">No stored credentials found for this guest. Enter SSH credentials to connect.</p>
        <form method="post" action="/terminal/{{ guest.id }}/connect-adhoc">
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="sshUsername" class="form-label">Username</label>
                    <input type="text" class="form-control" name="username" id="sshUsername" placeholder="root" value="root">
                </div>
                <div class="col-md-4">
                    <label for="sshPassword" class="form-label">Password</label>
                    <input type="password" class="form-control" name="password" id="sshPassword" placeholder="Password">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">
                        <i class="bi bi-plug"></i> Connect
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% if not resolved_ip %}
<div id="noIpWarning" class="alert alert-warning">
    <i class="bi bi-exclamation-triangle"></i> Could not resolve an IP address for this guest.
    Try running <a href="/hosts" class="alert-link">discovery</a> again, or the guest may not be running.
</div>
{% endif %}

<div id="terminal-container" style="background: #000; border-radius: 8px; padding: 4px; min-height: 500px;"></div>
{% endblock %}

{% block scripts %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css">
<script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.min.js"></script>
<script>
(function() {
    const term = new Terminal({
        cursorBlink: true,
        fontSize: 14,
        fontFamily: '"Cascadia Code", "Fira Code", "JetBrains Mono", monospace',
        theme: {
            background: '#0d1117',
            foreground: '#c9d1d9',
            cursor: '#58a6ff',
            selectionBackground: '#264f78',
            black: '#0d1117',
            red: '#ff7b72',
            green: '#7ee787',
            yellow: '#d29922',
            blue: '#58a6ff',
            magenta: '#bc8cff',
            cyan: '#39c5cf',
            white: '#c9d1d9',
        }
    });

    const fitAddon = new FitAddon.FitAddon();
    const webLinksAddon = new WebLinksAddon.WebLinksAddon();

    term.loadAddon(fitAddon);
    term.loadAddon(webLinksAddon);
    term.open(document.getElementById('terminal-container'));
    fitAddon.fit();

    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/terminal/{{ guest.id }}`;
    let ws = null;
    const needsCredentials = {{ 'true' if needs_credentials else 'false' }};
    const hasResolvedIp = {{ 'true' if resolved_ip else 'false' }};

    function connect() {
        ws = new WebSocket(wsUrl);

        ws.onopen = function() {
            term.writeln('\x1b[33mConnecting to {{ guest.name }} ({{ resolved_ip or "..." }})...\x1b[0m');
            // Send initial terminal size
            ws.send(JSON.stringify({type: 'resize', cols: term.cols, rows: term.rows}));
        };

        ws.onmessage = function(event) {
            const msg = JSON.parse(event.data);
            switch (msg.type) {
                case 'connected':
                    document.getElementById('connStatus').className = 'badge bg-success';
                    document.getElementById('connStatus').textContent = 'Connected';
                    break;
                case 'output':
                    term.write(msg.data);
                    break;
                case 'error':
                    term.writeln('\x1b[31m' + msg.data + '\x1b[0m');
                    document.getElementById('connStatus').className = 'badge bg-danger';
                    document.getElementById('connStatus').textContent = 'Error';
                    break;
                case 'disconnected':
                    term.writeln('\r\n\x1b[33m' + msg.data + '\x1b[0m');
                    document.getElementById('connStatus').className = 'badge bg-secondary';
                    document.getElementById('connStatus').textContent = 'Disconnected';
                    break;
            }
        };

        ws.onclose = function() {
            document.getElementById('connStatus').className = 'badge bg-secondary';
            document.getElementById('connStatus').textContent = 'Disconnected';
            term.writeln('\r\n\x1b[33mConnection closed.\x1b[0m');
        };

        ws.onerror = function() {
            document.getElementById('connStatus').className = 'badge bg-danger';
            document.getElementById('connStatus').textContent = 'Error';
        };
    }

    // Send keystrokes to server
    term.onData(function(data) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({type: 'input', data: data}));
        }
    });

    // Handle terminal resize
    window.addEventListener('resize', function() {
        fitAddon.fit();
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify({type: 'resize', cols: term.cols, rows: term.rows}));
        }
    });

    window.disconnect = function() {
        if (ws) {
            ws.close();
        }
    };

    // Auto-connect if we have IP and credentials
    if (hasResolvedIp && !needsCredentials) {
        connect();
    } else if (needsCredentials) {
        term.writeln('\x1b[33mEnter credentials above to connect.\x1b[0m');
        document.getElementById('connStatus').className = 'badge bg-warning';
        document.getElementById('connStatus').textContent = 'Credentials Required';
    } else {
        term.writeln('\x1b[31mCould not resolve IP address for this guest.\x1b[0m');
        term.writeln('\x1b[33mTry running discovery again or ensure the guest is running.\x1b[0m');
        document.getElementById('connStatus').className = 'badge bg-danger';
        document.getElementById('connStatus').textContent = 'No IP';
    }
})();
</script>
{% endblock %}
